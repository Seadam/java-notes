# WebStore 项目总结

## 1. 实现的功能

#### 后台

* **Category** 增、删、改、查
* **Product** 增、删、改、查、文件上传、多条件查询
* **Order** 删、查
* **Admin** 增、删、改、查
* **User** 增、查
* 显示列表 **分页**
* 后台登录权限控制

#### 前台

* 首页显示模块
  * 5 个活动 **banner** 图
  * 6 个随机 **Product**
* 用户模块
  * 用户注册，邮箱激活验证
  * 用户登录，验证码验证登录
  * 修改用户信息，仅支持修改昵称、密码、出生日期
* 购物车模块
  * 将商品加入购物车
  * 从购物车删除一项商品
* 订单模块
  * 下单
    * 选择购物车中商品下订单，事务处理
    * 判断商品库存是否足够，减少商品库存
    * 清空购物车
  * 取消订单



## 2. 额外的功能

#### 业务方面

* 密码 **MD5** 哈希计算后存储和验证
* 注册后发送电子邮件验证
* 登录时验证输入验证码
* 下单使用事务处理

#### 用户体验

* **AJAX 异步判断**
  * 添加管理员账号重复判断
  * 用户注册用户名重复判断
  * 添加的分类名重复判断
  * 前台简单**搜索框搜索词推荐补全**
* 后台删除商品、分类、订单**确认删除按钮**
* 有些 **JSP** 页面没有返回按钮，添加**返回上一页跳转**
* 用户详情页面， 可以查看到用户邮箱验证状态，可以发送验证邮箱

#### 代码优化

* 后台商品管理，修改商品图片时，上传新文件会删除掉旧文件
  * 文件以 **UUID** 防重名 + 多级目录存储
* 将多条件查询参数封装为 **SearchCondition** 类
* 将用户注册参数封装为 **UserFormBean** 类
* 前台 **Servlet** 和后台 **Servlet** 分离，权限控制，各司其职，同时还可以服用 **DAO** 层代码
* 用户创建时间以及下单时间，使用的是数据库的功能来实现**产生当前时间**
  * `createTime DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP`

#### 创新功能

* 创建一个新分类用于解决首页轮播图中尺寸不同问题
* 并且关联到实际商品，点击轮播图可以跳转到相关商品页面





## 3. 遇到的问题

#### 问题一

后台刚开始插入数据时，大多是测试数据，到后期正式插入数据时，在有自增的键上会造成编号混乱，需要删除表重建才能使其重新自增编号，解决方法：

* `TRUNCATE table category`  重置 **category** 表自增字段

#### 问题二

前端代码有些属性名没有按照驼峰命名规范，强迫症不能忍，解决方法：**全部改掉**

* 改的时候，**仔细最重要**
* **Domain** 类的属性名要与 **JSP** 和数据库中列名一致

#### 问题三

商品分类名前台后台都需要用到，可以放到内存中

* 当第一次加载时，读取放入 **ServletContext** 域中 `loadOnStartup = 1`
* 加一个过滤器，每次进行增、删、改操作后，更新域中数据

#### 问题四

后台多条件商品查询，拼接 **SQL** 语句以及传入 **SQL** 参数

* 拼接 **SQL** 语句
  * 避免判断 **and** 可以先写出 **WHERE** 语句 `select * from product where true`
  * 注意拼接语句之间的空格
  * 商品名使用 **like** 模糊查询
* 传入 **SQL** 参数
  * **QueryRunner** 参数接受可变参数列表，而可变参数列表本质上是一个数组
  * 构造一个 `List<Object> param`
  * 通过 `param.toArray()`  转化为数组传入可变参数列表中

#### 问题五

个人中心页面更新用户信息时，信息更新成功后回显没有及时更新，解决方法：

* 页面显示的是 **Session** 域中 **user** 数据
* 更新用户信息时，同时更新 **Session** 域中 **user** 数据（使用 `copyProperties`）
* 避免空指针，拿出 **user** 时判断，如果为空（用户长时间停留在同一页面，导致过期），先让用户登录

#### 问题六

邮箱验证登录时，使用 **jar** 包 `javax.mail.jar`，报错  **Activation ClassNotFound** 导包 `activation.jar`

如果是 QQ 邮箱，需要加上以下代码，不然会导致连不上服务器（网络上查到的解决方案）

```java
// 设置 QQ 邮箱 开启 SSL 加密传输
props.setProperty("mail.smtp.socketFactory.class", "javax.net.ssl.SSLSocketFactory");
props.setProperty("mail.smtp.port", "465");
props.setProperty("mail.smtp.socketFactory.port", "465");
```

#### 问题七

当由 **Sevlet／Jsp** 拼接请求参数再次请求到另一个 **Jsp** 时，**Jsp** 通过 `${param.name}` 拿到的请求参数乱码

原因分析：

* 通过抓包发现，浏览器拼接请求参数请求 **Jsp** 时，中文会使用 **UTF-8** 编码后拼接
* `?name=%E6%96%87%E5%AD%A6`  **Jsp** 拿到请求参数后，会通过 **UTF-8** 解码后显示到页面，没有乱码
* 但是 **Sevlet／Jsp** 拼接请求参数时，没有将参数进行 **UTF-8** 编码，导致编解码不一致出现乱码

解决方法：  **Sevlet／Jsp** 

* 拼接请求参数时，将参数进行 **UTF-8** 编码 `URLEncoder.encode(name, "UTF-8")`

## 4. 遇到的BUG

#### 局域网测试

全部 **localhost** 要变成实际的 **IP** 地址

* 返回首页
* 验证邮件地址

#### 分页跳转

前台搜索商品页面，当要搜索的商品为空时，点击尾页，页面异常

* 原因：商品为空时，`page.totalPageNum` 为 0
  * 而跳转链接地址 `<a href="javascript:searchPageSplit(${page.totalPageNum })">尾页</a>`
  * 跳转到第 0 页，出错
* 解决方法：
  * 前台**searchProducts.jsp** 判断，如果 `page.totalPageNum == 0`  ==> **page.totalPageNum = 1**
  * 后台，如果 `num == 0`  ==>  **num = 1**

在分页输入跳转页码按回车键进行跳转时，**回车键**导致表单提交，没有进行页码跳转

* 屏蔽表单回车跳转事件，给表单添加**回车键（键码为 13）**按键监听事件，当按下**回车键**时页面跳转
* `<form action="#" onkeypress="if(13 === event.keyCode){jump();return false;}">`

#### 防止表单重新提交

下单后，返回上一页，还能再次下单

屏蔽表单重复提交，使用 **Session** 和 **Token** 技术，未实现

#### 商品库存问题

商品库存不足时，可以加入购物车，可以下单。没有输入判断

* 在下单时，事务处理的时候进行判断，如果 **库存不足**，抛异常

```java
if (item.getSnum() < 0) {
  throw new IllegalStateException("请输入正确商品数量...");
}
```

商品详情页，如果购买的商品为负数，可以下单，并且商品库存会增加。没有输入判断

* 在加入购物车页面判断，如果提交 **负数值**，抛异常

```java
if (buynum > product.getPnum()) {
  // 如果下单数量大于商品库存，无法下单
  throw new IllegalStateException("商品库存不足，请调整商品数量或者等待补充库存...");
}
```

#### 搜索关键词空格问题

搜索时输入 `书` 能查出来，输入 `书` 加空格／空串，查不出来

* 服务端需要对输入的参数进行 `trim()` 操作







## 5. 感想

​        历时 7 天，做完较为完善的购物小商城。这次项目基于 Servlet／Jsp ，复习和实践了 Session、Cookie、FileUpload、JDBC连接池、事务等旧知识，同时也学习和练习了登录验证码、注册邮箱验证、列表分页、MD5 计算、多条件查询、多表事务处理等新知识，将 Java Web 以来所学知识都串联起来，巩固基础、强化知识吸收的同时也对项目有了一点点认知，算是打开了 Java Web 项目的大门。

​        项目中让我印象最深的就是，针对输入到服务器的参数的进行判断，空指针、参数类型不匹配问题层出不穷。为了保证输入的数据能够安全并且正确的到达数据库，不仅需要前端使用正则判断参数的正确合理性，后端拿到数据时，依旧要进行合理性判断，层层把关，规避空指针以及插入到数据库中类型不匹配问题。由此，我们可以使用表单 Bean 类，来传递前端提交的表单数据，当所有字段验证通过时，再将属性复制给实体 Bean 类插入到数据库。这让我想到一种情况，有没有场景是需要一个展示 Bean 类传递给前端，它只有实体 Bean 类的部分属性？

​        当然，这次项目也有一些困惑，在每一次数据库查询中，我都小心翼翼，很怕多次查询数据库会带来查询延迟、数据库负载等问题。做到购物车和订单时，一个简单的显示页面，就需要查多个表，填充多个 Bean 类。直到最后，我发现是我想多了，数据库数据本来就不多，根本都没有发挥出它真正的实力，闲置了很多资源。

​        在写代码途中，还发现不少问题，其中最大的问题就是重复代码太多。在 Controller 层获取请求参数，每个方法都要获取一遍，或者是写回浏览器时，转发、包含、refresh 或重定向的链接不同，要在每个方法都要写一遍，并且根据不同的业务返回结果，在同一个方法内会出现多次。我想，将来应该会学到更高级的框架来简化这些重复的操作吧。	

​        通过这次项目，我感受到原生 Servlet／Jsp 应用还有很多优化空间，应该是由更高级的框架来完成。学习掌握更高级的框架，提高代码效率，写出更优雅的代码，不禁有点小期待。

## 6. 引用 Jar 包

* `c3p0-0.9.1.2-jdk1.3.jar`
* `commons-beanutils-1.8.3.jar`
* `commons-dbutils-1.4.jar`
* `commons-logging-1.1.1.jar`
* `javax.servlet.jsp.jstl-1.2.1.jar`
* `javax.servlet.jsp.jstl-api-1.2.1.jar`
* `mysql-connector-java-5.1.44-bin.jar`


* `commons-fileupload-1.3.1.jar`
* `commons-io-2.4.jar`


* `javax.mail.jar`
* 工具类
  * 发邮件  `SendJMail.java`
  * 验证码  `VerifyCodeServlet.java`